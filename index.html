<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>littlemoments — Malcolm</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%23c4956a'/%3E%3Ctext x='50' y='68' font-family='Georgia,serif' font-size='52' font-weight='normal' font-style='italic' fill='white' text-anchor='middle'%3Em%3C/text%3E%3C/svg%3E" type="image/svg+xml">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  /* ─── THEME ─── */
  :root, [data-theme="light"] {
    --bg: #f6f1ea;
    --bg-surface: #fffdf9;
    --bg-elevated: #ffffff;
    --bg-hover: #f0eae0;
    --bg-nav: #eee8de;
    --border: #ddd5c8;
    --border-subtle: #e8e1d5;
    --text: #3b3630;
    --text-secondary: #6e665a;
    --text-muted: #a9a092;
    --accent: #c4956a;
    --accent-dim: #a87d56;
    --accent-glow: rgba(196, 149, 106, 0.12);
    --cat-quote: #7a6f5a;
    --cat-quote-bg: rgba(122, 111, 90, 0.10);
    --cat-first: #c4956a;
    --cat-first-bg: rgba(196, 149, 106, 0.12);
    --cat-funny: #b8894c;
    --cat-funny-bg: rgba(184, 137, 76, 0.12);
    --cat-note: #8a9a7a;
    --cat-note-bg: rgba(138, 154, 122, 0.10);
    --danger: #b85450;
    --danger-bg: rgba(184, 84, 80, 0.08);
    --done: #a9a092;
    --undo-bg: #3b3630;
    --undo-text: #f6f1ea;
    --modal-overlay: rgba(246, 241, 234, 0.85);
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.06);
    --shadow-lg: 0 8px 32px rgba(0,0,0,0.08);
  }

  [data-theme="dark"] {
    --bg: #1a1816;
    --bg-surface: #242220;
    --bg-elevated: #2c2a27;
    --bg-hover: #322f2b;
    --bg-nav: #201e1c;
    --border: #3a3733;
    --border-subtle: #312e2a;
    --text: #e5e0d5;
    --text-secondary: #9e978a;
    --text-muted: #6a645a;
    --accent: #d4a878;
    --accent-dim: #b8905e;
    --accent-glow: rgba(212, 168, 120, 0.12);
    --cat-quote: #b0a68e;
    --cat-quote-bg: rgba(176, 166, 142, 0.12);
    --cat-first: #d4a878;
    --cat-first-bg: rgba(212, 168, 120, 0.14);
    --cat-funny: #d4b46a;
    --cat-funny-bg: rgba(212, 180, 106, 0.14);
    --cat-note: #a0b490;
    --cat-note-bg: rgba(160, 180, 144, 0.12);
    --danger: #c45c5c;
    --danger-bg: rgba(196, 92, 92, 0.10);
    --done: #6a645a;
    --undo-bg: #e5e0d5;
    --undo-text: #1a1816;
    --modal-overlay: rgba(26, 24, 22, 0.88);
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.25);
    --shadow-lg: 0 8px 32px rgba(0,0,0,0.35);
  }

  :root {
    --radius: 8px;
    --radius-lg: 12px;
    --transition: 180ms ease;
    --font: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-display: 'DM Serif Display', Georgia, serif;
    --mono: 'JetBrains Mono', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font); background: var(--bg); color: var(--text);
    min-height: 100vh; line-height: 1.55; -webkit-font-smoothing: antialiased;
    transition: background 300ms ease, color 300ms ease;
  }

  .app { max-width: 680px; margin: 0 auto; padding: 0 20px; min-height: 100vh; display: flex; flex-direction: column; }

  /* ─── HEADER ─── */
  header {
    padding: 28px 0 20px; display: flex; align-items: center;
    justify-content: space-between; border-bottom: 1px solid var(--border-subtle);
  }
  .header-left { display: flex; align-items: center; gap: 14px; }
  .logo { display: flex; align-items: center; gap: 10px; cursor: default; }
  .logo-mark {
    width: 30px; height: 30px; border-radius: 8px;
    background: linear-gradient(135deg, var(--accent), var(--accent-dim));
    display: flex; align-items: center; justify-content: center;
    font-family: var(--font-display); font-style: italic;
    font-size: 17px; color: #fff; letter-spacing: -0.02em;
  }
  .logo-text {
    font-family: var(--font-display); font-size: 18px; font-weight: 400;
    letter-spacing: -0.01em; color: var(--text);
  }
  .logo-sub {
    font-family: var(--font); font-size: 11px; font-weight: 400;
    color: var(--text-muted); letter-spacing: 0.04em; margin-left: 2px;
  }

  .header-right { display: flex; align-items: center; gap: 8px; }

  .theme-toggle {
    width: 32px; height: 32px; border-radius: 6px; border: 1px solid var(--border-subtle);
    background: transparent; cursor: pointer; display: flex; align-items: center;
    justify-content: center; font-size: 14px; transition: all var(--transition);
    color: var(--text-muted);
  }
  .theme-toggle:hover { border-color: var(--border); color: var(--text-secondary); background: var(--bg-hover); }

  nav { display: flex; gap: 2px; background: var(--bg-nav); padding: 3px; border-radius: var(--radius); }
  nav button {
    font-family: var(--font); font-size: 13px; font-weight: 500; padding: 7px 16px;
    border: none; background: transparent; color: var(--text-muted); border-radius: 6px;
    cursor: pointer; transition: all var(--transition); position: relative;
  }
  nav button:hover { color: var(--text-secondary); }
  nav button.active { background: var(--bg-surface); color: var(--text); box-shadow: var(--shadow-sm); }
  nav button .badge {
    position: absolute; top: 2px; right: 4px; background: var(--accent); color: #fff;
    font-size: 10px; font-weight: 700; min-width: 16px; height: 16px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center; padding: 0 4px;
  }

  main { flex: 1; padding: 28px 0; }

  /* ─── CAPTURE VIEW ─── */
  .capture-view {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; min-height: 50vh;
  }
  .capture-prompt {
    font-family: var(--font-display); font-style: italic;
    font-size: 15px; color: var(--text-muted); margin-bottom: 20px;
    letter-spacing: 0.01em;
  }
  .capture-input-wrap { width: 100%; position: relative; }
  .capture-input {
    width: 100%; font-family: var(--font); font-size: 18px; font-weight: 300;
    padding: 20px 22px; background: var(--bg-surface); border: 1.5px solid var(--border);
    border-radius: var(--radius-lg); color: var(--text); outline: none;
    transition: all var(--transition); resize: none; line-height: 1.55;
    min-height: 72px; box-shadow: var(--shadow-sm);
  }
  .capture-input::placeholder { color: var(--text-muted); font-weight: 300; }
  .capture-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow), var(--shadow-md); }

  .capture-char-count {
    position: absolute; bottom: 8px; right: 14px; font-family: var(--mono);
    font-size: 10px; color: var(--text-muted); opacity: 0; transition: opacity 200ms;
  }
  .capture-input:focus ~ .capture-char-count { opacity: 1; }

  /* ─── CATEGORY CHIPS ─── */
  .category-bar {
    width: 100%; display: flex; gap: 6px; margin-top: 14px; flex-wrap: wrap;
    align-items: center;
  }
  .cat-chip {
    font-family: var(--font); font-size: 13px; font-weight: 500;
    padding: 7px 16px; border: 1.5px solid var(--border-subtle);
    background: transparent; border-radius: 20px; cursor: pointer;
    transition: all var(--transition); color: var(--text-muted);
    -webkit-tap-highlight-color: transparent;
  }
  .cat-chip:hover { border-color: var(--border); color: var(--text-secondary); }
  .cat-chip.selected { font-weight: 600; }
  .cat-chip[data-cat="quote"].selected { color: var(--cat-quote); background: var(--cat-quote-bg); border-color: rgba(122,111,90,0.3); }
  .cat-chip[data-cat="first"].selected { color: var(--cat-first); background: var(--cat-first-bg); border-color: rgba(196,149,106,0.35); }
  .cat-chip[data-cat="funny"].selected { color: var(--cat-funny); background: var(--cat-funny-bg); border-color: rgba(184,137,76,0.35); }
  .cat-chip[data-cat="note"].selected { color: var(--cat-note); background: var(--cat-note-bg); border-color: rgba(138,154,122,0.3); }

  .capture-meta { width: 100%; display: flex; gap: 10px; margin-top: 10px; align-items: flex-start; }

  /* ─── TAG INPUT ─── */
  .tag-container {
    flex: 1; position: relative;
    background: var(--bg-surface); border: 1px solid var(--border-subtle);
    border-radius: var(--radius); box-shadow: var(--shadow-sm);
    display: flex; flex-wrap: wrap; align-items: center; gap: 6px;
    padding: 6px 10px; transition: all var(--transition); min-height: 40px;
  }
  .tag-container:focus-within { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
  .tag-chip {
    display: inline-flex; align-items: center; gap: 4px;
    background: var(--bg-nav); color: var(--text); font-size: 13px;
    padding: 2px 8px; border-radius: 4px; animation: chipIn 150ms ease;
  }
  @keyframes chipIn { from { opacity: 0; transform: scale(0.85); } to { opacity: 1; transform: scale(1); } }
  .tag-chip .tag-remove { cursor: pointer; opacity: 0.4; font-size: 14px; margin-left: 2px; line-height: 1; }
  .tag-chip .tag-remove:hover { opacity: 1; color: var(--danger); }
  .tag-select-input {
    flex: 1; min-width: 70px; font-family: var(--font); font-size: 13px;
    border: none; background: transparent; color: var(--text); outline: none; padding: 4px 0;
  }
  .tag-select-input::placeholder { color: var(--text-muted); }
  .tag-dropdown {
    position: absolute; top: calc(100% + 4px); left: 0; right: 0;
    background: var(--bg-surface); border: 1px solid var(--border);
    border-radius: var(--radius); box-shadow: var(--shadow-lg); z-index: 100;
    max-height: 180px; overflow-y: auto; display: none;
  }
  .tag-dropdown.open { display: block; }
  .tag-option {
    padding: 8px 14px; font-size: 13px; cursor: pointer;
    color: var(--text-secondary); transition: background var(--transition);
  }
  .tag-option:hover, .tag-option.highlighted { background: var(--bg-hover); color: var(--text); }
  .tag-option.create-new { color: var(--accent); border-top: 1px solid var(--border-subtle); font-weight: 500; }

  .capture-btn {
    font-family: var(--font); font-size: 14px; font-weight: 600; padding: 10px 22px;
    background: linear-gradient(135deg, var(--accent), var(--accent-dim)); color: #fff;
    border: none; border-radius: var(--radius); cursor: pointer;
    transition: all var(--transition); white-space: nowrap; height: 40px;
    box-shadow: 0 2px 8px rgba(196,149,106,0.2);
  }
  .capture-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(196,149,106,0.3); }
  .capture-btn:active { transform: translateY(0); }

  .capture-hint {
    margin-top: 16px; font-size: 11px; color: var(--text-muted); font-family: var(--mono);
  }
  .capture-hint kbd {
    background: var(--bg-surface); padding: 2px 6px; border-radius: 4px;
    border: 1px solid var(--border-subtle); font-size: 10px; box-shadow: 0 1px 0 var(--border);
  }

  /* ─── DATE OVERRIDE ─── */
  .date-override-row {
    width: 100%; display: flex; align-items: center; gap: 8px; margin-top: 8px;
  }
  .date-override-label {
    font-size: 12px; color: var(--text-muted); white-space: nowrap;
  }
  .date-override-input {
    font-family: var(--font); font-size: 13px; padding: 5px 10px;
    background: var(--bg-surface); border: 1px solid var(--border-subtle);
    border-radius: var(--radius); color: var(--text); outline: none;
    transition: all var(--transition);
  }
  .date-override-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }

  /* ─── FLASH & UNDO ─── */
  .capture-flash {
    position: fixed; top: 20px; left: 50%;
    transform: translateX(-50%) translateY(-60px);
    background: var(--bg-surface); border: 1px solid var(--accent); color: var(--accent);
    padding: 10px 24px; border-radius: var(--radius); font-size: 14px; font-weight: 500;
    opacity: 0; transition: all 300ms ease; z-index: 200; pointer-events: none;
    box-shadow: var(--shadow-md);
  }
  .capture-flash.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  .undo-toast {
    position: fixed; bottom: 24px; left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--undo-bg); color: var(--undo-text);
    padding: 12px 20px; border-radius: var(--radius); font-size: 14px;
    display: flex; align-items: center; gap: 14px;
    opacity: 0; transition: all 300ms ease; z-index: 200;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  }
  .undo-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  .undo-toast button {
    font-family: var(--font); font-size: 13px; font-weight: 600; padding: 4px 14px;
    background: var(--accent); color: #fff; border: none; border-radius: 5px;
    cursor: pointer; transition: opacity 150ms;
  }
  .undo-toast button:hover { opacity: 0.85; }
  .undo-toast .undo-dismiss {
    background: transparent; color: var(--undo-text); opacity: 0.5; padding: 4px 8px; font-size: 16px;
  }

  /* ─── REVIEW ─── */
  .review-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 8px; }
  .review-title { font-family: var(--font-display); font-size: 22px; font-weight: 400; }
  .review-count { font-size: 12px; color: var(--text-muted); font-family: var(--mono); }

  .review-empty { text-align: center; padding: 80px 20px; color: var(--text-muted); }
  .review-empty-icon { font-size: 36px; margin-bottom: 14px; opacity: 0.35; }
  .review-empty h3 { font-family: var(--font-display); font-size: 18px; font-weight: 400; color: var(--text-secondary); margin-bottom: 6px; }
  .review-empty p { font-size: 14px; }

  .item-card {
    background: var(--bg-surface); border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg); padding: 18px 20px; margin-bottom: 10px;
    transition: all var(--transition); animation: slideIn 250ms ease;
    box-shadow: var(--shadow-sm); position: relative;
  }
  @keyframes slideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .item-card:hover { border-color: var(--border); box-shadow: var(--shadow-md); }
  .item-card.pinned { border-left: 3px solid var(--accent); }
  .item-card.review-focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }

  .item-text-edit {
    width: 100%; font-family: var(--font); font-size: 15px; line-height: 1.6;
    margin-bottom: 12px; background: transparent; border: none; resize: none;
    color: var(--text); padding: 0; outline: none; min-height: 24px;
    border-radius: 4px; transition: background 0.2s; overflow: hidden;
  }
  .item-text-edit:focus { background: var(--bg-hover); padding: 4px; margin: -4px -4px 12px -4px; }

  .item-text { font-size: 15px; line-height: 1.6; margin-bottom: 12px; white-space: pre-wrap; word-break: break-word; }
  .item-text .quote-mark { font-family: var(--font-display); font-style: italic; color: var(--cat-quote); opacity: 0.5; }

  .item-footer { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
  .item-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; font-size: 12px; color: var(--text-muted); font-family: var(--mono); }

  .item-tag {
    display: inline-flex; align-items: center; padding: 2px 9px;
    background: var(--accent-glow); color: var(--accent); border-radius: 20px;
    font-size: 11px; font-weight: 500; font-family: var(--font);
  }

  .cat-badge {
    font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;
    padding: 2px 8px; border-radius: 4px; font-family: var(--font);
  }
  .cat-badge.quote { background: var(--cat-quote-bg); color: var(--cat-quote); }
  .cat-badge.first { background: var(--cat-first-bg); color: var(--cat-first); }
  .cat-badge.funny { background: var(--cat-funny-bg); color: var(--cat-funny); }
  .cat-badge.note { background: var(--cat-note-bg); color: var(--cat-note); }

  .item-actions { display: flex; gap: 6px; flex-wrap: wrap; }
  .item-action-btn {
    font-family: var(--font); font-size: 12px; font-weight: 500; padding: 5px 12px;
    border: 1px solid var(--border-subtle); background: transparent;
    border-radius: 6px; cursor: pointer; transition: all var(--transition);
    -webkit-tap-highlight-color: transparent;
  }
  .item-action-btn:active { transform: scale(0.95); }
  .item-action-btn.pin-type { color: var(--accent); border-color: rgba(196,149,106,0.3); }
  .item-action-btn.pin-type:hover { background: var(--accent-glow); }
  .item-action-btn.pin-type.is-pinned { background: var(--accent-glow); font-weight: 600; }
  .item-action-btn.delete-type { color: var(--danger); border-color: rgba(184,84,80,0.2); }
  .item-action-btn.delete-type:hover { background: var(--danger-bg); }
  .item-action-btn.edit-type { color: var(--text-secondary); }
  .item-action-btn.edit-type:hover { background: var(--bg-hover); }

  /* Category selection in review */
  .review-cats { display: flex; gap: 4px; flex-wrap: wrap; }
  .review-cat-btn {
    font-family: var(--font); font-size: 11px; font-weight: 500; padding: 4px 10px;
    border: 1px solid var(--border-subtle); background: transparent;
    border-radius: 4px; cursor: pointer; transition: all var(--transition);
    color: var(--text-muted);
  }
  .review-cat-btn:hover { color: var(--text-secondary); }
  .review-cat-btn.selected { font-weight: 600; }
  .review-cat-btn[data-cat="quote"].selected { color: var(--cat-quote); background: var(--cat-quote-bg); border-color: rgba(122,111,90,0.3); }
  .review-cat-btn[data-cat="first"].selected { color: var(--cat-first); background: var(--cat-first-bg); border-color: rgba(196,149,106,0.35); }
  .review-cat-btn[data-cat="funny"].selected { color: var(--cat-funny); background: var(--cat-funny-bg); border-color: rgba(184,137,76,0.35); }
  .review-cat-btn[data-cat="note"].selected { color: var(--cat-note); background: var(--cat-note-bg); border-color: rgba(138,154,122,0.3); }

  /* ─── TIMELINE ─── */
  .timeline-controls { display: flex; gap: 10px; margin-bottom: 14px; flex-wrap: wrap; }
  .input-wrap { flex: 1; min-width: 160px; position: relative; }
  .input-wrap input {
    width: 100%; font-family: var(--font); font-size: 14px; padding: 9px 30px 9px 14px;
    background: var(--bg-surface); border: 1px solid var(--border-subtle);
    border-radius: var(--radius); color: var(--text); outline: none;
    transition: all var(--transition); box-shadow: var(--shadow-sm);
  }
  .input-wrap input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
  .input-wrap input::placeholder { color: var(--text-muted); }
  .input-clear {
    position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
    width: 20px; height: 20px; border-radius: 50%; border: none;
    background: var(--bg-hover); color: var(--text-muted); cursor: pointer;
    font-size: 13px; display: none; align-items: center; justify-content: center;
    transition: all var(--transition); line-height: 1;
  }
  .input-clear:hover { background: var(--border); color: var(--text); }
  .input-wrap.has-value .input-clear { display: flex; }

  .timeline-toolbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; flex-wrap: wrap; gap: 8px; }
  .cat-filters { display: flex; gap: 5px; flex-wrap: wrap; }
  .cat-filter-btn {
    font-family: var(--font); font-size: 12px; font-weight: 500; padding: 5px 12px;
    border: 1px solid var(--border-subtle); background: transparent; border-radius: 20px;
    cursor: pointer; transition: all var(--transition); color: var(--text-muted);
  }
  .cat-filter-btn:hover { color: var(--text-secondary); }
  .cat-filter-btn.active-all { background: var(--bg-hover); color: var(--text); border-color: var(--border); }
  .cat-filter-btn.active-quote { background: var(--cat-quote-bg); color: var(--cat-quote); border-color: rgba(122,111,90,0.3); }
  .cat-filter-btn.active-first { background: var(--cat-first-bg); color: var(--cat-first); border-color: rgba(196,149,106,0.35); }
  .cat-filter-btn.active-funny { background: var(--cat-funny-bg); color: var(--cat-funny); border-color: rgba(184,137,76,0.35); }
  .cat-filter-btn.active-note { background: var(--cat-note-bg); color: var(--cat-note); border-color: rgba(138,154,122,0.3); }

  .sort-select {
    font-family: var(--font); font-size: 12px; padding: 4px 8px;
    border: 1px solid var(--border-subtle); background: var(--bg-surface);
    border-radius: 6px; color: var(--text-secondary); cursor: pointer; outline: none;
  }

  .timeline-count { font-size: 12px; color: var(--text-muted); font-family: var(--mono); margin-bottom: 14px; }

  .date-group-label {
    font-family: var(--font-display); font-size: 13px; font-weight: 400;
    color: var(--text-muted); padding: 14px 0 6px;
    border-bottom: 1px solid var(--border-subtle); margin-bottom: 10px;
    letter-spacing: 0.01em;
  }

  .pin-indicator { color: var(--accent); font-size: 12px; margin-right: 2px; }

  /* ─── SETTINGS BAR ─── */
  .settings-bar {
    padding: 16px 0; border-top: 1px solid var(--border-subtle);
    display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;
  }
  .settings-left { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .settings-bar .subtle-btn {
    font-family: var(--mono); font-size: 11px; padding: 6px 12px;
    border: 1px solid var(--border-subtle); background: transparent;
    color: var(--text-muted); border-radius: 6px; cursor: pointer; transition: all var(--transition);
  }
  .settings-bar .subtle-btn:hover { border-color: var(--border); color: var(--text-secondary); background: var(--bg-hover); }
  .settings-bar .subtle-btn.danger:hover { border-color: rgba(184,84,80,0.3); color: var(--danger); background: var(--danger-bg); }
  .stats-text { font-family: var(--mono); font-size: 11px; color: var(--text-muted); }

  .sync-btn {
    display: inline-flex; align-items: center; gap: 6px;
    font-family: var(--font); font-size: 12px; font-weight: 500;
    padding: 6px 14px; border: 1px solid var(--border-subtle);
    background: transparent; color: var(--text-secondary); border-radius: 6px;
    cursor: pointer; transition: all var(--transition);
  }
  .sync-btn:hover { border-color: var(--border); color: var(--text); background: var(--bg-hover); }
  .sync-btn.syncing { color: var(--accent); border-color: rgba(196,149,106,0.3); }
  .sync-btn.synced { color: var(--cat-note); border-color: rgba(138,154,122,0.3); }
  .sync-btn.sync-error { color: var(--danger); border-color: rgba(184,84,80,0.3); }
  .sync-dot {
    width: 8px; height: 8px; border-radius: 50%; background: var(--border);
    display: inline-block; flex-shrink: 0;
  }
  .sync-btn.syncing .sync-dot { background: var(--accent); animation: pulse 1s infinite; }
  .sync-btn.synced .sync-dot { background: var(--cat-note); }
  .sync-btn.sync-error .sync-dot { background: var(--danger); }
  @keyframes pulse { 0%{opacity:1} 50%{opacity:0.4} 100%{opacity:1} }

  /* ─── MODAL ─── */
  .modal-overlay {
    position: fixed; inset: 0; background: var(--modal-overlay);
    backdrop-filter: blur(6px); z-index: 500; display: none;
    align-items: center; justify-content: center; padding: 20px;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--bg-surface); border: 1px solid var(--border);
    border-radius: var(--radius-lg); padding: 28px; max-width: 460px;
    width: 100%; box-shadow: var(--shadow-lg);
  }
  .modal h3 { font-family: var(--font-display); font-size: 18px; font-weight: 400; margin-bottom: 12px; }
  .modal p { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.6; }
  .modal-input {
    width: 100%; padding: 10px 14px; margin-bottom: 16px;
    border: 1px solid var(--border); border-radius: var(--radius);
    font-family: var(--font); font-size: 14px; color: var(--text);
    background: var(--bg-surface); outline: none;
  }
  .modal-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
  .modal-btn {
    font-family: var(--font); font-size: 13px; font-weight: 500; padding: 8px 20px;
    border-radius: var(--radius); cursor: pointer; transition: all var(--transition);
    border: 1px solid var(--border); background: transparent; color: var(--text-secondary);
  }
  .modal-btn:hover { color: var(--text); background: var(--bg-hover); }
  .modal-btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
  .modal-btn.primary:hover { opacity: 0.9; }
  .modal-btn.confirm-danger { background: var(--danger); border-color: var(--danger); color: #fff; }

  /* ─── RESPONSIVE ─── */
  @media (max-width: 600px) {
    .app { padding: 0 14px; }
    header { padding: 20px 0 16px; flex-wrap: wrap; gap: 12px; }
    .capture-input { font-size: 16px; padding: 16px 18px; }
    .capture-meta { flex-direction: column; }
    .capture-btn { width: 100%; text-align: center; }
    nav button { padding: 7px 12px; font-size: 12px; }
    .timeline-controls { flex-direction: column; }
    .item-footer { flex-direction: column; align-items: flex-start; }
    .item-action-btn { padding: 8px 16px; font-size: 13px; }
    .settings-bar { flex-direction: column; align-items: flex-start; }
  }

  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

  .hidden { display: none !important; }
</style>
</head>
<body data-theme="light">

<div class="app">
  <header>
    <div class="header-left">
      <div class="logo">
        <div class="logo-mark">m</div>
        <div class="logo-text">littlemoments</div>
        <span class="logo-sub">Malcolm</span>
      </div>
    </div>
    <div class="header-right">
      <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">&#9788;</button>
      <nav id="nav">
        <button class="active" data-view="capture">Capture</button>
        <button data-view="review">Review <span class="badge hidden" id="review-badge">0</span></button>
        <button data-view="timeline">Timeline</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- ═══ CAPTURE ═══ -->
    <section id="view-capture" class="capture-view">
      <div class="capture-prompt">what just happened?</div>
      <div class="capture-input-wrap">
        <textarea class="capture-input" id="capture-input" placeholder="A moment worth remembering..." rows="2"></textarea>
        <div class="capture-char-count" id="char-count">0</div>
      </div>
      <div class="category-bar" id="category-bar">
        <button class="cat-chip" data-cat="quote">Quote</button>
        <button class="cat-chip" data-cat="first">First</button>
        <button class="cat-chip" data-cat="funny">Funny</button>
        <button class="cat-chip" data-cat="note">Note</button>
      </div>
      <div class="capture-meta">
        <div class="tag-container" id="tag-container">
          <input type="text" class="tag-select-input" id="tag-input" placeholder="Tags..." autocomplete="off">
          <div class="tag-dropdown" id="tag-dropdown"></div>
        </div>
        <button class="capture-btn" id="capture-btn">Capture</button>
      </div>
      <div class="date-override-row">
        <span class="date-override-label">When:</span>
        <input type="datetime-local" class="date-override-input" id="date-override">
        <button class="date-override-label" id="date-now-btn" style="cursor:pointer;text-decoration:underline;border:none;background:none;font-family:var(--font);color:var(--accent);">now</button>
      </div>
      <div class="capture-hint"><kbd>Ctrl</kbd>+<kbd>Enter</kbd> capture · <kbd>/</kbd> focus</div>
    </section>

    <!-- ═══ REVIEW ═══ -->
    <section id="view-review" class="hidden">
      <div class="review-header">
        <h2 class="review-title">Review</h2>
        <span class="review-count" id="review-count"></span>
      </div>
      <div id="review-list"></div>
    </section>

    <!-- ═══ TIMELINE ═══ -->
    <section id="view-timeline" class="hidden">
      <div class="timeline-controls">
        <div class="input-wrap" id="search-wrap">
          <input type="text" id="search-input" placeholder="Search moments...">
          <button class="input-clear" id="search-clear">&times;</button>
        </div>
        <div class="input-wrap" id="filter-wrap">
          <input type="text" id="filter-tag-input" placeholder="Filter by tag..." autocomplete="off">
          <button class="input-clear" id="filter-clear">&times;</button>
          <div class="tag-dropdown" id="filter-tag-dropdown"></div>
        </div>
      </div>
      <div class="timeline-toolbar">
        <div class="cat-filters" id="cat-filters">
          <button class="cat-filter-btn active-all" data-cat="all">All</button>
          <button class="cat-filter-btn" data-cat="quote">Quotes</button>
          <button class="cat-filter-btn" data-cat="first">Firsts</button>
          <button class="cat-filter-btn" data-cat="funny">Funny</button>
          <button class="cat-filter-btn" data-cat="note">Notes</button>
          <button class="cat-filter-btn" data-cat="uncategorised">Inbox</button>
        </div>
        <select class="sort-select" id="sort-select">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
        </select>
      </div>
      <div class="timeline-count" id="timeline-count"></div>
      <div id="timeline-list"></div>
    </section>
  </main>

  <div class="settings-bar">
    <div class="settings-left">
      <button class="sync-btn" id="manual-sync-btn" title="Sync now">
        <span id="sync-indicator" class="sync-dot"></span>
        <span id="sync-label">Sync</span>
      </button>
      <span class="stats-text" id="stats-text"></span>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="subtle-btn" id="cloud-btn">Sync Settings</button>
      <button class="subtle-btn" id="purge-btn" style="display:none">Empty Trash</button>
      <button class="subtle-btn" id="export-btn">Export</button>
      <button class="subtle-btn" id="import-btn">Import</button>
      <button class="subtle-btn danger" id="clear-btn">Clear All</button>
    </div>
  </div>
</div>

<div class="capture-flash" id="capture-flash">&#10003; Captured</div>

<div class="undo-toast" id="undo-toast">
  <span id="undo-text">Moment removed</span>
  <button id="undo-btn">Undo</button>
  <button class="undo-dismiss" id="undo-dismiss">&times;</button>
</div>

<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <h3 id="modal-title">Confirm</h3>
    <p id="modal-body">Are you sure?</p>
    <div id="modal-content"></div>
    <div class="modal-actions">
      <button class="modal-btn" id="modal-cancel">Cancel</button>
      <button class="modal-btn primary" id="modal-confirm">Confirm</button>
    </div>
  </div>
</div>

<input type="file" id="import-file" accept=".json" style="display:none">

<script>
// ═══════════════════════════════════════════
// DATA LAYER
// ═══════════════════════════════════════════
const STORAGE_KEY = 'littlemoments_data';
const CLOUD_URL_KEY = 'littlemoments_cloud_url';
const THEME_KEY = 'littlemoments_theme';
const CATEGORIES = ['quote', 'first', 'funny', 'note'];

function loadData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      const d = JSON.parse(raw);
      if (!Array.isArray(d.items)) d.items = [];
      if (!Array.isArray(d.tags)) d.tags = [];
      d.items = d.items.filter(i => i && typeof i.id === 'string' && typeof i.text === 'string');
      d.items.forEach(i => {
        if (!Array.isArray(i.tags)) i.tags = i.tag ? [i.tag] : [];
        if (!i.category) i.category = '';
        if (!i.createdAt) i.createdAt = new Date().toISOString();
        if (typeof i.pinned === 'undefined') i.pinned = false;
        delete i.tag;
      });
      // Auto-purge soft-deleted items >30 days
      const PURGE_MS = 30 * 24 * 60 * 60 * 1000;
      d.items = d.items.filter(i => {
        if (!i._deleted) return true;
        if (!i._deletedAt) return false;
        return (Date.now() - new Date(i._deletedAt).getTime()) < PURGE_MS;
      });
      return d;
    }
  } catch (e) { console.error('Data load error:', e); }
  return { items: [], tags: [] };
}

let _suppressSync = false;

function saveData(d) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
  if (!_suppressSync) triggerCloudSync(d);
}

let data = loadData();

// ═══════════════════════════════════════════
// CLOUD SYNC
// ═══════════════════════════════════════════
let cloudUrl = localStorage.getItem(CLOUD_URL_KEY) || '';
const syncBtn = document.getElementById('manual-sync-btn');
const syncLabel = document.getElementById('sync-label');
let syncTimeout = null;
let lastSyncTime = null;

function setSyncStatus(status, title) {
  syncBtn.className = 'sync-btn';
  if (status === 'loading') { syncBtn.classList.add('syncing'); syncLabel.textContent = 'Syncing...'; }
  else if (status === 'ok') { syncBtn.classList.add('synced'); syncLabel.textContent = title || 'Synced'; }
  else if (status === 'error') { syncBtn.classList.add('sync-error'); syncLabel.textContent = title || 'Error'; }
  else { syncLabel.textContent = cloudUrl ? 'Sync' : 'Offline'; }
  syncBtn.title = title || status || 'Click to sync';
}

syncBtn.addEventListener('click', () => {
  if (cloudUrl && validateCloudUrl(cloudUrl)) fetchCloudData();
  else document.getElementById('cloud-btn').click();
});

function validateCloudUrl(url) {
  if (!url) return false;
  try { const u = new URL(url); return u.hostname === 'script.google.com' && u.pathname.startsWith('/macros/s/'); }
  catch { return false; }
}

function validateCloudData(d) {
  if (!d || typeof d !== 'object') return false;
  if (!Array.isArray(d.items)) return false;
  return d.items.every(i => i && typeof i.id === 'string' && typeof i.text === 'string');
}

function sanitizeCloudItem(item) {
  return {
    id: String(item.id).slice(0, 50),
    text: String(item.text).slice(0, 10000),
    tags: Array.isArray(item.tags) ? item.tags.map(t => String(t).slice(0, 100)).slice(0, 20) : [],
    category: CATEGORIES.includes(item.category) ? item.category : '',
    createdAt: item.createdAt || new Date().toISOString(),
    updatedAt: item.updatedAt || null,
    pinned: !!item.pinned,
    _deleted: !!item._deleted,
    _deletedAt: item._deletedAt || null
  };
}

function fetchCloudData() {
  if (!cloudUrl || !validateCloudUrl(cloudUrl)) return;
  setSyncStatus('loading', 'Pulling...');
  fetch(cloudUrl, { method: 'GET', redirect: 'follow' })
    .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
    .then(cloudData => {
      if (cloudData.error) { setSyncStatus('error', 'Server: ' + cloudData.error); return; }
      if (!validateCloudData(cloudData)) { setSyncStatus('error', 'Invalid cloud data'); return; }
      const safeItems = cloudData.items.map(sanitizeCloudItem);
      const cloudMap = new Map(safeItems.map(i => [i.id, i]));
      const localMap = new Map(data.items.map(i => [i.id, i]));
      const mergedMap = new Map();
      for (const [id, item] of cloudMap) {
        const local = localMap.get(id);
        if (!local) { mergedMap.set(id, item); continue; }
        if (item._deleted || local._deleted) {
          const winner = item._deleted ? item : local;
          mergedMap.set(id, { ...winner, _deleted: true, _deletedAt: winner._deletedAt || new Date().toISOString() });
          continue;
        }
        const cloudTime = new Date(item.updatedAt || item.createdAt);
        const localTime = new Date(local.updatedAt || local.createdAt);
        mergedMap.set(id, localTime > cloudTime ? local : item);
      }
      for (const [id, item] of localMap) { if (!mergedMap.has(id)) mergedMap.set(id, item); }
      _suppressSync = true;
      data.items = Array.from(mergedMap.values());
      data.items.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      if (Array.isArray(cloudData.tags)) {
        cloudData.tags.forEach(t => { const clean = String(t).slice(0, 100); if (clean && !data.tags.includes(clean)) data.tags.push(clean); });
      }
      saveData(data);
      _suppressSync = false;
      pushToCloud(data);
      renderCurrentView();
      lastSyncTime = new Date();
      setSyncStatus('ok', 'Synced ' + formatTime(lastSyncTime.toISOString()));
    })
    .catch(e => { console.error('Cloud fetch error:', e); _suppressSync = false; setSyncStatus('error', 'Pull failed'); });
}

function pushToCloud(d) {
  if (!cloudUrl || !validateCloudUrl(cloudUrl)) return Promise.resolve();
  return fetch(cloudUrl, { method: 'POST', redirect: 'follow', body: JSON.stringify(d) })
    .then(() => { lastSyncTime = new Date(); setSyncStatus('ok', 'Synced ' + formatTime(lastSyncTime.toISOString())); })
    .catch(e => { console.error('Cloud push error:', e); setSyncStatus('error', 'Push failed'); });
}

function triggerCloudSync(d) {
  if (!cloudUrl || !validateCloudUrl(cloudUrl)) return;
  setSyncStatus('loading', 'Saving...');
  clearTimeout(syncTimeout);
  syncTimeout = setTimeout(() => pushToCloud(d), 1500);
}

document.addEventListener('visibilitychange', () => { if (!document.hidden && cloudUrl) fetchCloudData(); });
if (cloudUrl && validateCloudUrl(cloudUrl)) { setSyncStatus('loading', 'Connecting...'); setTimeout(fetchCloudData, 500); }
else if (cloudUrl && !validateCloudUrl(cloudUrl)) { setSyncStatus('error', 'Invalid sync URL'); }

// ═══════════════════════════════════════════
// ITEM OPERATIONS
// ═══════════════════════════════════════════
function addItem(text, category, tags, dateOverride) {
  const item = {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
    text: text.trim(),
    category: category || '',
    tags: (tags || []).map(t => t.trim()).filter(Boolean),
    createdAt: dateOverride || new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    pinned: false
  };
  data.items.unshift(item);
  // Sort by createdAt in case of date override
  data.items.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  item.tags.forEach(t => { if (!data.tags.includes(t)) data.tags.push(t); });
  data.tags.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
  saveData(data);
  return item;
}

function updateItem(id, updates) {
  const item = data.items.find(i => i.id === id);
  if (!item) return;
  Object.assign(item, updates, { updatedAt: new Date().toISOString() });
  if (updates.tags) {
    updates.tags.forEach(t => { if (!data.tags.includes(t)) data.tags.push(t); });
  }
  saveData(data);
}

function togglePin(id) {
  const item = data.items.find(i => i.id === id);
  if (item) { item.pinned = !item.pinned; saveData(data); }
}

function deleteItem(id) {
  const item = data.items.find(i => i.id === id);
  if (!item) return null;
  item._deleted = true;
  item._deletedAt = new Date().toISOString();
  saveData(data);
  return { ...item, _deleted: false, _deletedAt: null };
}

function restoreItem(item) {
  if (!item) return;
  const existing = data.items.find(i => i.id === item.id);
  if (existing) { existing._deleted = false; existing._deletedAt = null; }
  else { item._deleted = false; item._deletedAt = null; data.items.push(item); }
  data.items.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  saveData(data);
}

function purgeAllDeleted() { data.items = data.items.filter(i => !i._deleted); saveData(data); }

function getUncategorised() { return data.items.filter(i => !i.category && !i._deleted); }
function getActiveItems() { return data.items.filter(i => !i._deleted); }

function searchItems(query, tag, cat, sort) {
  let r = data.items.filter(i => !i._deleted);
  if (cat && cat !== 'all') {
    if (cat === 'uncategorised') r = r.filter(i => !i.category);
    else r = r.filter(i => i.category === cat);
  }
  if (tag) r = r.filter(i => Array.isArray(i.tags) && i.tags.some(t => t.toLowerCase() === tag.toLowerCase()));
  if (query) {
    const q = query.toLowerCase();
    r = r.filter(i => i.text.toLowerCase().includes(q) || (Array.isArray(i.tags) && i.tags.some(t => t.toLowerCase().includes(q))));
  }
  r.sort((a, b) => {
    if (a.pinned && !b.pinned) return -1;
    if (!a.pinned && b.pinned) return 1;
    const da = new Date(a.createdAt), db = new Date(b.createdAt);
    return sort === 'oldest' ? da - db : db - da;
  });
  return r;
}

// ═══════════════════════════════════════════
// UNDO
// ═══════════════════════════════════════════
let undoStack = [];
let undoTimer = null;
const undoToast = document.getElementById('undo-toast');
const undoText = document.getElementById('undo-text');

function pushUndo(label, item) {
  undoStack = [{ label, item }];
  undoText.textContent = label;
  undoToast.classList.add('show');
  clearTimeout(undoTimer);
  undoTimer = setTimeout(() => { undoToast.classList.remove('show'); undoStack = []; }, 6000);
}

document.getElementById('undo-btn').addEventListener('click', () => {
  if (undoStack.length === 0) return;
  restoreItem(undoStack.pop().item);
  undoToast.classList.remove('show');
  clearTimeout(undoTimer);
  renderCurrentView();
});
document.getElementById('undo-dismiss').addEventListener('click', () => {
  undoToast.classList.remove('show'); clearTimeout(undoTimer); undoStack = [];
});

// ═══════════════════════════════════════════
// THEME
// ═══════════════════════════════════════════
const themeToggle = document.getElementById('theme-toggle');
let currentTheme = localStorage.getItem(THEME_KEY) || 'light';
applyTheme(currentTheme);

function applyTheme(theme) {
  currentTheme = theme;
  document.body.setAttribute('data-theme', theme);
  themeToggle.innerHTML = theme === 'dark' ? '&#9790;' : '&#9788;';
  localStorage.setItem(THEME_KEY, theme);
}
themeToggle.addEventListener('click', () => applyTheme(currentTheme === 'dark' ? 'light' : 'dark'));

// ═══════════════════════════════════════════
// VIEW MANAGEMENT
// ═══════════════════════════════════════════
const views = ['capture', 'review', 'timeline'];
let currentView = 'capture';

function switchView(view) {
  currentView = view;
  views.forEach(v => document.getElementById(`view-${v}`).classList.toggle('hidden', v !== view));
  document.querySelectorAll('#nav button').forEach(btn => btn.classList.toggle('active', btn.dataset.view === view));
  if (view === 'review') renderReview();
  if (view === 'timeline') renderTimeline();
  if (view === 'capture') document.getElementById('capture-input').focus();
  updateBadge(); updateStats();
}
document.querySelectorAll('#nav button').forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));

// ═══════════════════════════════════════════
// CAPTURE
// ═══════════════════════════════════════════
const captureInput = document.getElementById('capture-input');
const tagInput = document.getElementById('tag-input');
const tagContainer = document.getElementById('tag-container');
const tagDropdown = document.getElementById('tag-dropdown');
const captureFlash = document.getElementById('capture-flash');
const charCount = document.getElementById('char-count');
const dateOverride = document.getElementById('date-override');
let activeTags = [];
let selectedCategory = '';

// Set date override to now
function setDateNow() {
  const now = new Date();
  const offset = now.getTimezoneOffset();
  const local = new Date(now.getTime() - offset * 60000);
  dateOverride.value = local.toISOString().slice(0, 16);
}
setDateNow();
document.getElementById('date-now-btn').addEventListener('click', setDateNow);

captureInput.addEventListener('input', () => {
  captureInput.style.height = 'auto';
  captureInput.style.height = Math.max(72, captureInput.scrollHeight) + 'px';
  charCount.textContent = captureInput.value.length;
});

// Category chips
document.querySelectorAll('#category-bar .cat-chip').forEach(chip => {
  chip.addEventListener('click', () => {
    const cat = chip.dataset.cat;
    if (selectedCategory === cat) {
      selectedCategory = '';
      chip.classList.remove('selected');
    } else {
      selectedCategory = cat;
      document.querySelectorAll('#category-bar .cat-chip').forEach(c => c.classList.remove('selected'));
      chip.classList.add('selected');
    }
  });
});

function renderActiveTags() {
  tagContainer.querySelectorAll('.tag-chip').forEach(c => c.remove());
  activeTags.forEach((t, i) => {
    const chip = document.createElement('div');
    chip.className = 'tag-chip';
    chip.innerHTML = escapeHtml(t) + ' <span class="tag-remove" data-index="' + i + '">&times;</span>';
    tagContainer.insertBefore(chip, tagInput);
  });
}

tagContainer.addEventListener('click', (e) => {
  if (e.target.classList.contains('tag-remove')) { activeTags.splice(parseInt(e.target.dataset.index), 1); renderActiveTags(); }
  else if (e.target === tagContainer) tagInput.focus();
});

function addActiveTag(tagStr) {
  const clean = tagStr.trim();
  if (clean && !activeTags.includes(clean)) { activeTags.push(clean); renderActiveTags(); }
  tagInput.value = '';
}

function doCapture() {
  const text = captureInput.value.trim();
  if (!text) { captureInput.focus(); return; }
  if (tagInput.value.trim()) addActiveTag(tagInput.value);

  // Parse date override
  let dateISO = null;
  if (dateOverride.value) {
    dateISO = new Date(dateOverride.value).toISOString();
  }

  addItem(text, selectedCategory, [...activeTags], dateISO);

  // Reset
  captureInput.value = '';
  captureInput.style.height = 'auto';
  charCount.textContent = '0';
  activeTags = [];
  renderActiveTags();
  tagInput.value = '';
  tagDropdown.classList.remove('open');
  selectedCategory = '';
  document.querySelectorAll('#category-bar .cat-chip').forEach(c => c.classList.remove('selected'));
  setDateNow();
  showFlash('Moment captured');
  captureInput.focus();
  updateBadge(); updateStats();
}

document.getElementById('capture-btn').addEventListener('click', doCapture);
captureInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); doCapture(); }
});

// ═══════════════════════════════════════════
// TAG AUTOCOMPLETE
// ═══════════════════════════════════════════
function setupTagAutocomplete(input, dropdown, onSelect) {
  let highlighted = -1;
  function render() {
    const val = input.value.toLowerCase();
    const matches = data.tags.filter(t => t.toLowerCase().includes(val));
    let html = '';
    matches.forEach((t, i) => {
      html += '<div class="tag-option" data-tag="' + escapeAttr(t) + '" data-index="' + i + '">' + escapeHtml(t) + '</div>';
    });
    if (val && !data.tags.some(t => t.toLowerCase() === val)) {
      html += '<div class="tag-option create-new" data-tag="' + escapeAttr(input.value.trim()) + '" data-index="' + matches.length + '">+ Create "' + escapeHtml(input.value.trim()) + '"</div>';
    }
    dropdown.innerHTML = html;
    highlighted = -1;
    if (html) dropdown.classList.add('open'); else dropdown.classList.remove('open');
  }
  function selectOption(tag) {
    if (onSelect) onSelect(tag); else input.value = tag;
    dropdown.classList.remove('open');
  }
  input.addEventListener('input', render);
  input.addEventListener('focus', render);
  input.addEventListener('keydown', (e) => {
    const options = dropdown.querySelectorAll('.tag-option');
    if (e.key === 'Enter') {
      if (dropdown.classList.contains('open') && highlighted >= 0) { e.preventDefault(); selectOption(options[highlighted].dataset.tag); }
      else if (input.value.trim()) { e.preventDefault(); if (onSelect) onSelect(input.value.trim()); }
    } else if (e.key === 'ArrowDown') {
      if (!dropdown.classList.contains('open')) return;
      e.preventDefault(); highlighted = Math.min(highlighted + 1, options.length - 1);
      options.forEach((o, i) => o.classList.toggle('highlighted', i === highlighted));
    } else if (e.key === 'ArrowUp') {
      if (!dropdown.classList.contains('open')) return;
      e.preventDefault(); highlighted = Math.max(highlighted - 1, 0);
      options.forEach((o, i) => o.classList.toggle('highlighted', i === highlighted));
    } else if (e.key === 'Escape') { dropdown.classList.remove('open'); }
    else if (e.key === ',' && onSelect) { e.preventDefault(); if (input.value.trim()) onSelect(input.value.trim()); }
  });
  dropdown.addEventListener('click', (e) => { const opt = e.target.closest('.tag-option'); if (opt) selectOption(opt.dataset.tag); });
  document.addEventListener('click', (e) => {
    if (!input.contains(e.target) && !dropdown.contains(e.target) && !e.target.closest('.tag-container'))
      dropdown.classList.remove('open');
  });
}

setupTagAutocomplete(tagInput, tagDropdown, (tag) => addActiveTag(tag));
const filterTagInput = document.getElementById('filter-tag-input');
const filterTagDropdown = document.getElementById('filter-tag-dropdown');
setupTagAutocomplete(filterTagInput, filterTagDropdown, (tag) => {
  filterTagInput.value = tag;
  filterTagDropdown.classList.remove('open');
  updateInputWrap('filter-wrap', tag);
  renderTimeline();
});
filterTagInput.addEventListener('input', () => { updateInputWrap('filter-wrap', filterTagInput.value); if (!filterTagInput.value) renderTimeline(); });

document.getElementById('search-clear').addEventListener('click', () => { document.getElementById('search-input').value = ''; updateInputWrap('search-wrap', ''); renderTimeline(); });
document.getElementById('filter-clear').addEventListener('click', () => { filterTagInput.value = ''; updateInputWrap('filter-wrap', ''); renderTimeline(); });
function updateInputWrap(id, val) { document.getElementById(id).classList.toggle('has-value', !!val); }
document.getElementById('search-input').addEventListener('input', function() { updateInputWrap('search-wrap', this.value); renderTimeline(); });

// ═══════════════════════════════════════════
// REVIEW
// ═══════════════════════════════════════════
let reviewFocusIdx = -1;

function renderReview() {
  const list = document.getElementById('review-list');
  const items = getUncategorised();
  document.getElementById('review-count').textContent = items.length + ' uncategorised';
  reviewFocusIdx = -1;

  if (items.length === 0) {
    list.innerHTML = '<div class="review-empty"><div class="review-empty-icon">&#9826;</div><h3>All caught up</h3><p>No moments to review. Go capture some.</p></div>';
    return;
  }

  list.innerHTML = items.map((item, idx) => `
    <div class="item-card" data-id="${escapeAttr(item.id)}" data-review-idx="${idx}">
      <textarea class="item-text-edit" data-id="${escapeAttr(item.id)}">${escapeTextareaContent(item.text)}</textarea>
      <div class="item-footer">
        <div class="item-meta">
          ${(item.tags||[]).map(t => '<span class="item-tag">' + escapeHtml(t) + '</span>').join('')}
          <span>${formatTime(item.createdAt)}</span>
        </div>
        <div class="item-actions">
          <div class="review-cats">
            ${CATEGORIES.map(c => `<button class="review-cat-btn ${item.category === c ? 'selected' : ''}" data-cat="${c}" data-id="${escapeAttr(item.id)}">${c.charAt(0).toUpperCase() + c.slice(1)}</button>`).join('')}
          </div>
          <button class="item-action-btn delete-type" data-action="delete" data-id="${escapeAttr(item.id)}">Remove</button>
        </div>
      </div>
    </div>`).join('');

  // Category assignment
  list.querySelectorAll('.review-cat-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      updateItem(btn.dataset.id, { category: btn.dataset.cat });
      renderReview(); updateBadge(); updateStats();
    });
  });

  // Delete
  list.querySelectorAll('.item-action-btn.delete-type').forEach(btn => {
    btn.addEventListener('click', () => {
      const removed = deleteItem(btn.dataset.id);
      if (removed) pushUndo('Moment removed', removed);
      renderReview(); updateBadge(); updateStats();
    });
  });

  // Inline edit
  list.querySelectorAll('textarea.item-text-edit').forEach(area => {
    autoSizeTextarea(area);
    area.addEventListener('input', () => autoSizeTextarea(area));
    area.addEventListener('blur', () => {
      const item = data.items.find(i => i.id === area.dataset.id);
      if (item && item.text !== area.value) updateItem(area.dataset.id, { text: area.value.trim() });
    });
  });
}

function autoSizeTextarea(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }

// ═══════════════════════════════════════════
// TIMELINE
// ═══════════════════════════════════════════
let activeCat = 'all';

document.querySelectorAll('#cat-filters .cat-filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    activeCat = btn.dataset.cat;
    document.querySelectorAll('#cat-filters .cat-filter-btn').forEach(b => b.className = 'cat-filter-btn');
    const clsMap = { all: 'active-all', quote: 'active-quote', first: 'active-first', funny: 'active-funny', note: 'active-note', uncategorised: 'active-all' };
    btn.classList.add(clsMap[activeCat] || 'active-all');
    renderTimeline();
  });
});
document.getElementById('sort-select').addEventListener('change', () => renderTimeline());

function renderTimeline() {
  const query = document.getElementById('search-input').value;
  const tag = filterTagInput.value;
  const sort = document.getElementById('sort-select').value;
  const results = searchItems(query, tag, activeCat, sort);
  const list = document.getElementById('timeline-list');
  document.getElementById('timeline-count').textContent = results.length + ' moment' + (results.length !== 1 ? 's' : '');

  if (results.length === 0) {
    list.innerHTML = '<div class="review-empty"><div class="review-empty-icon">&#9826;</div><h3>No moments yet</h3><p>Capture something and it\'ll appear here.</p></div>';
    return;
  }

  const groups = groupByDate(results);
  let html = '';

  for (const [label, items] of groups) {
    html += '<div class="date-group-label">' + escapeHtml(label) + '</div>';
    html += items.map(item => {
      const catCls = item.category || '';
      const catLabel = item.category ? item.category.charAt(0).toUpperCase() + item.category.slice(1) : 'Uncategorised';
      const isQuote = item.category === 'quote';
      const displayText = isQuote
        ? '<span class="quote-mark">&ldquo;</span>' + escapeHtml(item.text) + '<span class="quote-mark">&rdquo;</span>'
        : escapeHtml(item.text);
      return `
      <div class="item-card retrieve-item ${item.pinned ? 'pinned' : ''}" data-id="${escapeAttr(item.id)}">
        <div class="item-text">${item.pinned ? '<span class="pin-indicator">&#9873;</span> ' : ''}${displayText}</div>
        <div class="item-footer">
          <div class="item-meta">
            <span class="cat-badge ${catCls}">${catLabel}</span>
            ${(item.tags||[]).map(t => '<span class="item-tag">' + escapeHtml(t) + '</span>').join('')}
            <span>${formatTime(item.createdAt)}</span>
          </div>
          <div class="item-actions">
            <button class="item-action-btn pin-type ${item.pinned ? 'is-pinned' : ''}" data-action="pin" data-id="${escapeAttr(item.id)}">${item.pinned ? 'Unpin' : 'Pin'}</button>
            <button class="item-action-btn delete-type" data-action="delete" data-id="${escapeAttr(item.id)}">Delete</button>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  list.innerHTML = html;

  list.querySelectorAll('.item-action-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id, action = btn.dataset.action;
      if (action === 'delete') { const removed = deleteItem(id); if (removed) pushUndo('Moment deleted', removed); }
      else if (action === 'pin') togglePin(id);
      renderTimeline(); updateBadge(); updateStats();
    });
  });
}

function groupByDate(items) {
  const groups = new Map();
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
  const weekAgo = new Date(today); weekAgo.setDate(today.getDate() - 7);

  items.forEach(item => {
    const d = new Date(item.createdAt);
    let label;
    if (d >= today) label = 'Today';
    else if (d >= yesterday) label = 'Yesterday';
    else if (d >= weekAgo) label = 'This Week';
    else label = d.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
    if (!groups.has(label)) groups.set(label, []);
    groups.get(label).push(item);
  });
  return groups;
}

// ═══════════════════════════════════════════
// BADGE & STATS
// ═══════════════════════════════════════════
function updateBadge() {
  const count = getUncategorised().length;
  const badge = document.getElementById('review-badge');
  badge.textContent = count;
  badge.classList.toggle('hidden', count === 0);
}

function updateStats() {
  const active = getActiveItems();
  const total = active.length;
  const quotes = active.filter(i => i.category === 'quote').length;
  const firsts = active.filter(i => i.category === 'first').length;
  const funny = active.filter(i => i.category === 'funny').length;
  const inbox = getUncategorised().length;
  const deleted = data.items.filter(i => i._deleted).length;
  let text = total + ' moments';
  if (quotes) text += ' · ' + quotes + ' quotes';
  if (firsts) text += ' · ' + firsts + ' firsts';
  if (funny) text += ' · ' + funny + ' funny';
  if (inbox) text += ' · ' + inbox + ' inbox';
  if (deleted > 0) text += ' · ' + deleted + ' trash';
  document.getElementById('stats-text').textContent = text;
  document.getElementById('purge-btn').style.display = deleted > 0 ? '' : 'none';
}

// ═══════════════════════════════════════════
// MODAL
// ═══════════════════════════════════════════
let modalCallback = null;
const modal = {
  overlay: document.getElementById('modal-overlay'),
  title: document.getElementById('modal-title'),
  body: document.getElementById('modal-body'),
  content: document.getElementById('modal-content'),
  cancel: document.getElementById('modal-cancel'),
  confirm: document.getElementById('modal-confirm'),
  open(title, body, contentBuilder, onConfirm, confirmText, isDanger) {
    modal.title.textContent = title;
    modal.body.textContent = body;
    modal.content.innerHTML = '';
    if (contentBuilder) contentBuilder(modal.content);
    modal.confirm.textContent = confirmText || 'Confirm';
    modal.confirm.className = isDanger ? 'modal-btn confirm-danger' : 'modal-btn primary';
    modal.overlay.classList.add('open');
    modalCallback = onConfirm;
    const firstInput = modal.content.querySelector('input');
    if (firstInput) setTimeout(() => firstInput.focus(), 100);
  },
  close() { modal.overlay.classList.remove('open'); modalCallback = null; }
};
modal.cancel.addEventListener('click', modal.close);
modal.confirm.addEventListener('click', () => { if (modalCallback) modalCallback(); modal.close(); });
modal.overlay.addEventListener('click', (e) => { if (e.target === modal.overlay) modal.close(); });

// ═══════════════════════════════════════════
// SETTINGS
// ═══════════════════════════════════════════
document.getElementById('export-btn').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = 'littlemoments-malcolm-' + new Date().toISOString().slice(0, 10) + '.json';
  a.click(); URL.revokeObjectURL(url);
});

document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file').click());
document.getElementById('import-file').addEventListener('change', (e) => {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const imported = JSON.parse(reader.result);
      if (imported.items && Array.isArray(imported.items)) {
        const existingIds = new Set(data.items.map(i => i.id));
        let count = 0;
        imported.items.forEach(i => {
          if (!existingIds.has(i.id)) {
            if (!Array.isArray(i.tags)) i.tags = i.tag ? [i.tag] : [];
            if (!i.category) i.category = '';
            if (!i.createdAt) i.createdAt = new Date().toISOString();
            i.pinned = !!i.pinned;
            delete i.tag;
            data.items.push(i);
            count++;
          }
        });
        if (imported.tags) imported.tags.forEach(t => { if (!data.tags.includes(t)) data.tags.push(t); });
        data.items.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        saveData(data);
        renderCurrentView();
        showFlash('Imported ' + count + ' moments');
      } else { throw new Error('Invalid'); }
    } catch (err) { alert('Invalid file. Expected littlemoments JSON.'); }
  };
  reader.readAsText(file);
  e.target.value = '';
});

document.getElementById('clear-btn').addEventListener('click', () => {
  modal.open('Clear all moments?', 'This permanently deletes everything. Export first if you want a backup.', null, () => {
    data = { items: [], tags: [] };
    saveData(data); renderCurrentView();
  }, 'Clear All', true);
});

document.getElementById('purge-btn').addEventListener('click', () => {
  const trashCount = data.items.filter(i => i._deleted).length;
  modal.open('Empty trash?',
    'Permanently remove ' + trashCount + ' deleted moment' + (trashCount !== 1 ? 's' : '') + '. This cannot be undone.',
    null, () => { purgeAllDeleted(); renderCurrentView(); showFlash('Trash emptied'); }, 'Empty Trash', true);
});

document.getElementById('cloud-btn').addEventListener('click', () => {
  modal.open('Sync Settings',
    'Paste your Google Apps Script Web App URL to sync moments between you and your partner.',
    (container) => {
      const input = document.createElement('input');
      input.type = 'text'; input.className = 'modal-input'; input.id = 'cloud-url-input';
      input.placeholder = 'https://script.google.com/macros/s/...';
      input.value = cloudUrl;
      container.appendChild(input);
      if (lastSyncTime) {
        const info = document.createElement('p');
        info.style.cssText = 'font-size:12px;color:var(--text-muted)';
        info.textContent = 'Last synced: ' + lastSyncTime.toLocaleString();
        container.appendChild(info);
      }
    },
    () => {
      const url = document.getElementById('cloud-url-input').value.trim();
      if (url && validateCloudUrl(url)) { localStorage.setItem(CLOUD_URL_KEY, url); cloudUrl = url; fetchCloudData(); }
      else if (url) { alert('Enter a valid Google Apps Script URL.'); }
      else { localStorage.removeItem(CLOUD_URL_KEY); cloudUrl = ''; setSyncStatus('', 'Not connected'); }
    }, 'Save');
});

// ═══════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════
function escapeHtml(str) {
  if (typeof str !== 'string') return '';
  const div = document.createElement('div'); div.textContent = str; return div.innerHTML;
}
function escapeAttr(str) {
  if (typeof str !== 'string') return '';
  return str.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function escapeTextareaContent(str) {
  if (typeof str !== 'string') return '';
  return str.replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function formatTime(iso) {
  const d = new Date(iso), now = new Date(), diff = now - d;
  if (diff < 0) return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
  if (diff < 172800000) return 'yesterday';
  return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
}
function showFlash(text) {
  captureFlash.textContent = '\u2713 ' + text;
  captureFlash.classList.add('show');
  setTimeout(() => captureFlash.classList.remove('show'), 1200);
}
function renderCurrentView() {
  if (currentView === 'review') renderReview();
  if (currentView === 'timeline') renderTimeline();
  updateBadge(); updateStats();
}

// ═══════════════════════════════════════════
// KEYBOARD SHORTCUTS
// ═══════════════════════════════════════════
document.addEventListener('keydown', (e) => {
  const tag = e.target.tagName;
  const isInput = tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';

  if (e.key === '/' && !isInput) { e.preventDefault(); switchView('capture'); captureInput.focus(); return; }
  if (e.key === 'Escape') {
    if (modal.overlay.classList.contains('open')) { modal.close(); return; }
    if (undoToast.classList.contains('show')) { undoToast.classList.remove('show'); return; }
  }
  if (isInput) return;

  if (e.key === '1') switchView('capture');
  if (e.key === '2') switchView('review');
  if (e.key === '3') switchView('timeline');

  // Review keyboard nav
  if (currentView === 'review') {
    const cards = document.querySelectorAll('#review-list .item-card');
    if (cards.length === 0) return;
    if (e.key === 'j' || e.key === 'ArrowDown') {
      e.preventDefault(); reviewFocusIdx = Math.min(reviewFocusIdx + 1, cards.length - 1);
      cards.forEach((c, i) => c.classList.toggle('review-focus', i === reviewFocusIdx));
      cards[reviewFocusIdx].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }
    if (e.key === 'k' || e.key === 'ArrowUp') {
      e.preventDefault(); reviewFocusIdx = Math.max(reviewFocusIdx - 1, 0);
      cards.forEach((c, i) => c.classList.toggle('review-focus', i === reviewFocusIdx));
      cards[reviewFocusIdx].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }
    if (reviewFocusIdx >= 0 && reviewFocusIdx < cards.length) {
      const id = cards[reviewFocusIdx].dataset.id;
      if (e.key === 'q') { updateItem(id, { category: 'quote' }); renderReview(); updateBadge(); updateStats(); }
      if (e.key === 'f') { updateItem(id, { category: 'first' }); renderReview(); updateBadge(); updateStats(); }
      if (e.key === 'u') { updateItem(id, { category: 'funny' }); renderReview(); updateBadge(); updateStats(); }
      if (e.key === 'n') { updateItem(id, { category: 'note' }); renderReview(); updateBadge(); updateStats(); }
      if (e.key === 'd') { const removed = deleteItem(id); if (removed) pushUndo('Moment removed', removed); renderReview(); updateBadge(); updateStats(); }
    }
  }
});

// ═══════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════
updateBadge();
updateStats();
captureInput.focus();
</script>
</body>
</html>
